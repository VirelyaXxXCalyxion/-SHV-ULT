---
import { getCollection } from "astro:content";
import MusicRelicsLayout from "../../layouts/MusicRelicsLayout.astro";

const relics = await getCollection("music-relics");

// Get all music relic MDX files
const musicRelicFiles = import.meta.glob('./*.mdx', { eager: true });
const musicRelics = Object.values(musicRelicFiles);

const platformEmoji: Record<string, string> = {
  amazon: 'ðŸŽµ',
  spotify: 'ðŸŽ§',
  youtube: 'â–¶ï¸',
  bandcamp: 'ðŸŽ¼',
  other: 'ðŸ”¥'
};

// sort newest first
relics.sort((a, b) => (a.data.created < b.data.created ? 1 : -1));

const featured = relics.filter(r => r.data.featured);
const rest = relics.filter(r => !r.data.featured);

// build filter vocab
const uniq = (arr: string[]) => Array.from(new Set(arr.filter(Boolean))).sort((a,b) => a.localeCompare(b));

const allKinds = uniq(relics.map(r => r.data.kind));
const allMoods = uniq(relics.flatMap(r => r.data.mood ?? []));
const allThemes = uniq(relics.flatMap(r => r.data.themes ?? []));
---

<MusicRelicsLayout title="Music Relics">
  <h1>Music Relics</h1>
  <p>Music is a shared pulse between us - an invocation in its own right.</p>

<section class="controls" aria-label="Music Relics filters">
  <div class="searchRow">
    <input id="relicSearch" type="search" placeholder="Search: title, artist, mood, theme..." autocomplete="off" />
    <button id="clearAll" type="button" class="btnGhost">Clear</button>
  </div>

  <div class="filters">
    <div class="filterBlock">
      <div class="label">Kind</div>
      <div class="chipRow" id="kindChips">
        {allKinds.map(k => <button type="button" class="chip" data-kind={k}>{k}</button>)}
      </div>
    </div>

    <div class="filterBlock">
      <div class="label">Mood</div>
      <div class="chipRow" id="moodChips">
        {allMoods.map(m => <button type="button" class="chip" data-mood={m}>{m}</button>)}
      </div>
    </div>

    <div class="filterBlock">
      <div class="label">Themes</div>
      <div class="chipRow" id="themeChips">
        {allThemes.map(t => <button type="button" class="chip" data-theme={t}>{t}</button>)}
      </div>
    </div>
  </div>

  <div class="active" id="activeState" aria-live="polite"></div>
</section>

{featured.length > 0 && (
  <>
    <h2>Featured</h2>
    <div class="grid" id="featuredGrid">
      {featured.map(r => (
        <a
          class="card relicCard"
          href={`music-relics/${r.data.slug ?? r.id}/`}
          data-title={r.data.title}
          data-artist={r.data.artist}
          data-kind={r.data.kind}
          data-moods={(r.data.mood ?? []).join("|")}
          data-themes={(r.data.themes ?? []).join("|")}
          data-tags={(r.data.tags ?? []).join("|")}
        >
          <div class="title">{r.data.title}</div>
          <div class="sub">{r.data.artist} Â· {r.data.kind}</div>
          <div class="chips">
            {(r.data.mood ?? []).slice(0,3).map((m: string) => <span class="pill">{m}</span>)}
          </div>
        </a>
      ))}
    </div>
  </>
)}

<h2>All Relics</h2>
<div class="grid" id="allGrid">
  {rest.map(r => (
    <a
      class="card relicCard"
      href={`music-relics/${r.data.slug ?? r.id}/`}
      data-title={r.data.title}
      data-artist={r.data.artist}
      data-kind={r.data.kind}
      data-moods={(r.data.mood ?? []).join("|")}
      data-themes={(r.data.themes ?? []).join("|")}
      data-tags={(r.data.tags ?? []).join("|")}
    >
      <div class="title">{r.data.title}</div>
      <div class="sub">{r.data.artist} Â· {r.data.kind}</div>
      <div class="chips">
        {(r.data.themes ?? []).slice(0,3).map((t: string) => <span class="pill">{t}</span>)}
      </div>
    </a>
  ))}
</div>

<p class="empty" id="emptyState" hidden>
  Nothing matches. Adjust filters, or admit reality is cruel. ðŸ–¤
</p>

<script is:inline>
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));

  const state = {
    q: "",
    kinds: new Set(),
    moods: new Set(),
    themes: new Set(),
    mode: {
      moods: "any",   // "any" | "all"
      themes: "any",  // "any" | "all"
    }
  };

  const search = $("#relicSearch");
  const clearAll = $("#clearAll");
  const activeState = $("#activeState");
  const activePills = $("#activePills");
  const emptyState = $("#emptyState");

  const cards = $$(".relicCard");

  function norm(v){ return (v ?? "").toString().toLowerCase().trim(); }

  function splitPipe(raw){
    return (raw || "")
      .split("|")
      .map(s => s.trim())
      .filter(Boolean);
  }

  function listHasAll(list, set){
    // list is array of strings, set is Set
    for (const v of set) if (!list.includes(v)) return false;
    return true;
  }

  function listHasAny(list, set){
    for (const v of set) if (list.includes(v)) return true;
    return false;
  }

  function matchSet(list, set, mode){
    if (set.size === 0) return true;
    if (mode === "all") return listHasAll(list, set);
    return listHasAny(list, set);
  }

  function syncChips(){
    // reflect state sets onto chip buttons
    const map = [
      { sel: "#kindChips .chip", attr: "data-kind", set: state.kinds },
      { sel: "#moodChips .chip", attr: "data-mood", set: state.moods },
      { sel: "#themeChips .chip", attr: "data-theme", set: state.themes },
    ];

    map.forEach(({sel, attr, set}) => {
      $$(sel).forEach(btn => {
        const val = btn.getAttribute(attr);
        const on = set.has(val);
        btn.classList.toggle("on", on);
        btn.setAttribute("aria-pressed", on ? "true" : "false");
      });
    });
  }

  function syncKnifeButtons(){
    $$(".knifeBtn").forEach(btn => {
      const target = btn.getAttribute("data-target");
      const mode = btn.getAttribute("data-mode");
      const on = state.mode[target] === mode;
      btn.classList.toggle("on", on);
      btn.setAttribute("aria-pressed", on ? "true" : "false");
    });
  }

  function renderActiveText(){
    const parts = [];

    if (state.kinds.size) parts.push(`Kind: ${Array.from(state.kinds).join(", ")}`);
    if (state.moods.size) parts.push(`Mood(${state.mode.moods.toUpperCase()}): ${Array.from(state.moods).join(", ")}`);
    if (state.themes.size) parts.push(`Themes(${state.mode.themes.toUpperCase()}): ${Array.from(state.themes).join(", ")}`);
    if (state.q) parts.push(`Search: "${state.q}"`);

    activeState.textContent = parts.length ? ("Active â†’ " + parts.join(" | ")) : "";
  }

  function pill(label, group, value){
    const b = document.createElement("button");
    b.type = "button";
    b.className = "pill";
    b.textContent = label + " âœ•";
    b.addEventListener("click", () => {
      if (group === "q") {
        state.q = "";
        search.value = "";
      } else {
        state[group].delete(value);
      }
      syncChips();
      renderPills();
      apply();
    });
    return b;
  }

  function renderPills(){
    if (!activePills) return;
    activePills.innerHTML = "";

    // Search pill
    if (state.q) activePills.appendChild(pill(`Search: ${state.q}`, "q", null));

    // Kind pills
    for (const k of state.kinds) {
      activePills.appendChild(pill(`Kind: ${k}`, "kinds", k));
    }

    // Mood pills
    for (const m of state.moods) {
      activePills.appendChild(pill(`Mood: ${m}`, "moods", m));
    }

    // Theme pills
    for (const t of state.themes) {
      activePills.appendChild(pill(`Theme: ${t}`, "themes", t));
    }
  }

  function apply(){
    let shown = 0;

    cards.forEach(card => {
      const title = norm(card.dataset.title);
      const artist = norm(card.dataset.artist);
      const kind = (card.dataset.kind || "").trim();

      const moods = splitPipe(card.getAttribute("data-moods"));
      const themes = splitPipe(card.getAttribute("data-themes"));
      const tags = splitPipe(card.getAttribute("data-tags"));

      const haystack = [
        title,
        artist,
        norm(kind),
        norm(moods.join(" ")),
        norm(themes.join(" ")),
        norm(tags.join(" "))
      ].join(" ");

      const matchQ = state.q ? haystack.includes(norm(state.q)) : true;

      // kinds: match ANY selected kind
      const matchKind = state.kinds.size ? state.kinds.has(kind) : true;

      // moods/themes: match ANY or ALL based on knife mode
      const matchMood = matchSet(moods, state.moods, state.mode.moods);
      const matchTheme = matchSet(themes, state.themes, state.mode.themes);

      const ok = matchQ && matchKind && matchMood && matchTheme;

      card.style.display = ok ? "" : "none";
      if (ok) shown++;
    });

    emptyState.hidden = shown !== 0;

    renderActiveText();
    renderPills();
  }

  // Search
  search?.addEventListener("input", (e) => {
    state.q = e.target.value;
    apply();
  });

  // Clear all
  clearAll?.addEventListener("click", () => {
    state.q = "";
    state.kinds.clear();
    state.moods.clear();
    state.themes.clear();

    // keep knife modes as-is (or reset if you want)
    // state.mode.moods = "any";
    // state.mode.themes = "any";

    if (search) search.value = "";

    syncChips();
    syncKnifeButtons();
    renderPills();
    apply();
  });

  // Chip wiring (multi-select)
  function toggleSet(set, value){
    if (set.has(value)) set.delete(value);
    else set.add(value);
  }

  function wire(groupId, setKey, attr){
    const set = state[setKey];
    $$("#" + groupId + " .chip").forEach(btn => {
      btn.setAttribute("aria-pressed", "false");
      btn.addEventListener("click", () => {
        const val = btn.getAttribute(attr);
        toggleSet(set, val);
        syncChips();
        renderPills();
        apply();
      });
    });
  }

  wire("kindChips", "kinds", "data-kind");
  wire("moodChips", "moods", "data-mood");
  wire("themeChips", "themes", "data-theme");

  // Knife toggles (ANY/ALL)
  $$(".knifeBtn").forEach(btn => {
    btn.setAttribute("aria-pressed", "false");
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-target"); // "moods" | "themes"
      const mode = btn.getAttribute("data-mode");     // "any" | "all"
      state.mode[target] = mode;
      syncKnifeButtons();
      apply();
    });
  });

  // Init UI
  syncChips();
  syncKnifeButtons();
  renderPills();
  apply();
</script>


<style>
  p{opacity:.86;max-width:72ch}
  h2{margin-top:24px}

  /* Controls */
  .controls{
    margin:18px 0 10px;
    padding:14px 14px 10px;
    border-radius:22px;
    border:1px solid rgba(212,175,55,.18);
    background:rgba(0,0,0,.22);
  }
  .searchRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input[type="search"]{
    flex:1;min-width:220px;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(212,175,55,.22);
    background:rgba(0,0,0,.35);
    color:inherit;
    outline:none;
  }
  input[type="search"]::placeholder{opacity:.7}
  .btnGhost{
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(212,175,55,.22);
    background:transparent;color:inherit;opacity:.9;
    cursor:pointer;
  }
  .btnGhost:hover{border-color:rgba(212,175,55,.4)}
  .filters{display:grid;gap:12px;margin-top:12px}
  .filterBlock .label{font-size:.82rem;opacity:.75;margin-bottom:6px}
  .chipRow{display:flex;flex-wrap:wrap;gap:8px}
  .chip{
    font-size:.8rem;
    padding:6px 10px;border-radius:999px;
    border:1px solid rgba(212,175,55,.22);
    background:rgba(0,0,0,.18);
    color:inherit;
    cursor:pointer;
    transition:transform .12s ease,border-color .12s ease, background .12s ease;
  }
  .chip:hover{transform:translateY(-1px);border-color:rgba(212,175,55,.38)}
  .chip.on{
    background:rgba(212,175,55,.16);
    border-color:rgba(212,175,55,.55);
  }
  .active{margin-top:10px;font-size:.85rem;opacity:.8}

  /* Grid + Cards */
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:16px;margin-top:14px
  }
  .card{
    display:block;
    padding:18px;
    border-radius:22px;
    text-decoration:none;
    color:inherit;
    border:1px solid rgba(212,175,55,.18);
    background:radial-gradient(120% 120% at 10% 0%, rgba(212,175,55,.09), rgba(0,0,0,.28));
    box-shadow: 0 0 0 rgba(0,0,0,0);
    transition:transform .12s ease,border-color .12s ease, box-shadow .12s ease;
  }
  .card:hover{
    transform:translateY(-2px);
    border-color:rgba(212,175,55,.42);
    box-shadow: 0 12px 24px rgba(0,0,0,.22);
  }
  .title{font-size:1.06rem;font-weight:750;letter-spacing:.3px}
  .sub{opacity:.75;font-size:.92rem;margin-top:7px}
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:12px}
  .pill{
    font-size:.78rem;opacity:.86;
    padding:4px 10px;border-radius:999px;
    border:1px solid rgba(212,175,55,.18);
    background:rgba(0,0,0,.18);
  }
  .empty{margin-top:14px;opacity:.75}

  <div class="knifeRow">
  <div class="knifeGroup">
    <span class="knifeLabel">Mood</span>
    <div class="knifeToggle" role="group" aria-label="Mood match mode">
      <button type="button" class="knifeBtn on" data-mode="any" data-target="moods">ANY</button>
      <button type="button" class="knifeBtn" data-mode="all" data-target="moods">ALL</button>
    </div>
  </div>

  <div class="knifeGroup">
    <span class="knifeLabel">Themes</span>
    <div class="knifeToggle" role="group" aria-label="Theme match mode">
      <button type="button" class="knifeBtn on" data-mode="any" data-target="themes">ANY</button>
      <button type="button" class="knifeBtn" data-mode="all" data-target="themes">ALL</button>
    </div>
  </div>
</div>

<div id="activePills" class="activePills" aria-live="polite"></div>

.knifeRow{
  display:flex;
  gap:16px;
  flex-wrap:wrap;
  align-items:center;
  margin-top:12px;
}

.knifeGroup{
  display:flex;
  gap:10px;
  align-items:center;
}

.knifeLabel{
  opacity:.8;
  font-size:.9rem;
}

.knifeToggle{
  display:flex;
  gap:8px;
}

.knifeBtn{
  border:1px solid rgba(255,255,255,.18);
  background:transparent;
  padding:6px 10px;
  border-radius:999px;
  cursor:pointer;
  opacity:.8;
}

.knifeBtn.on{
  opacity:1;
  border-color: rgba(255,80,80,.6);
  box-shadow: 0 0 0 1px rgba(255,80,80,.2) inset;
}

.activePills{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:12px;
}

.pill{
  border:1px solid rgba(255,255,255,.16);
  background:rgba(0,0,0,.25);
  padding:6px 10px;
  border-radius:999px;
  cursor:pointer;
  opacity:.85;
}

.pill:hover{ opacity:1; }

</style>


